<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç­ç´šä½œæ¥­é€²åº¦è³½è·‘æ¦œ</title>
  
  <!-- 1. è¼‰å…¥ Tailwind CSS (æ¨£å¼) -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- 2. è¼‰å…¥ React å’Œ Babel (æ ¸å¿ƒ) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- 3. è¨­å®š Import Map (åªä¿ç•™ Firebase) -->
  <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"
      }
    }
  </script>

  <style>
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    .animate-shimmer {
      animation: shimmer 2s infinite;
    }
  </style>
</head>
<body class="bg-slate-950 text-slate-100">
  <div id="root"></div>

  <!-- 4. ä¸»è¦ç¨‹å¼ç¢¼ -->
  <script type="text/babel" data-type="module">
    import { initializeApp } from 'firebase/app';
    import { 
      getFirestore, collection, doc, setDoc, onSnapshot, 
      serverTimestamp, query, orderBy, increment, updateDoc, getDoc 
    } from 'firebase/firestore';
    import { 
      getAuth, signInAnonymously, onAuthStateChanged 
    } from 'firebase/auth';

    // --- è¨­å®šå€ ---
    const firebaseConfig = {
      apiKey: "AIzaSyAjmg0KXLaR_Z6Bj_nwyLN2Z2QPBOPMLvw",
      authDomain: "math-smart1.firebaseapp.com",
      projectId: "math-smart1",
      storageBucket: "math-smart1.firebasestorage.app",
      messagingSenderId: "867006036032",
      appId: "1:867006036032:web:bb23af4520c316b5ad07a5"
    };

    const APP_ID = "math-class-2024";

    // åˆå§‹åŒ– Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- å…ƒä»¶ ---

    const LoginScreen = ({ onJoin, isTeacher, setIsTeacher, authReady }) => {
      const [name, setName] = React.useState('');
      const [loading, setLoading] = React.useState(false);

      const handleJoin = async () => {
        if (!name.trim()) return;
        setLoading(true);
        await onJoin(name);
        setLoading(false);
      };

      return (
        <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4 font-sans text-slate-100">
          <div className="max-w-md w-full bg-slate-800 rounded-2xl shadow-2xl overflow-hidden border border-slate-700">
            <div className="bg-blue-600 p-6 text-center">
              <div className="text-5xl mb-2">âš¡</div>
              <h1 className="text-2xl font-bold text-white">æ•¸å­¸ä½œæ¥­è¡åˆºè³½</h1>
              <p className="text-blue-200 text-sm">2-1 è‡³ 2-4 é€²åº¦è¿½è¹¤</p>
            </div>
            <div className="p-8 space-y-6">
              <div>
                <label className="block text-sm font-medium text-slate-300 mb-2">
                  è¼¸å…¥ä½ çš„åå­—é–‹å§‹
                </label>
                <input
                  type="text"
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜"
                  className="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-white placeholder-slate-400 transition-all"
                  onKeyDown={(e) => e.key === 'Enter' && handleJoin()}
                  disabled={!authReady}
                />
              </div>
              
              <button
                onClick={handleJoin}
                disabled={loading || !name.trim() || !authReady}
                className="w-full bg-blue-500 hover:bg-blue-600 active:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl transition-all transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-blue-500/30"
              >
                {!authReady ? 'é€£ç·šä¸­...' : loading ? 'åŠ å…¥ä¸­...' : 'é–‹å§‹åšé¡Œï¼'}
              </button>

              <div className="pt-4 border-t border-slate-700">
                 <button
                  onClick={() => setIsTeacher(true)}
                  disabled={!authReady}
                  className="w-full text-sm text-slate-500 hover:text-slate-300 transition-colors disabled:opacity-50"
                >
                  æˆ‘æ˜¯è€å¸« (é–‹å•Ÿç™½æ¿æ¨¡å¼)
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    const LoadingScreen = () => (
      <div className="min-h-screen bg-slate-950 flex flex-col items-center justify-center text-slate-400">
        <div className="text-4xl animate-spin mb-4">â³</div>
        <p>æ­£åœ¨æ¢å¾©ä½ çš„é€²åº¦...</p>
        <p className="text-xs text-slate-600 mt-2">å¦‚æœå¡ä½è¶…é 5 ç§’ï¼Œè«‹æª¢æŸ¥è³‡æ–™åº«æ¬Šé™</p>
      </div>
    );

    const ErrorScreen = ({ error }) => {
      const isPermissionError = error.code === 'permission-denied' || (error.message && error.message.includes('Missing or insufficient permissions'));
      
      return (
        <div className="min-h-screen bg-slate-950 flex items-center justify-center p-4">
          <div className="max-w-lg w-full bg-slate-900 border border-red-800 rounded-xl p-6 shadow-2xl">
            <div className="flex items-center gap-3 mb-4 text-red-500">
              <div className="text-3xl">âš ï¸</div>
              <h2 className="text-xl font-bold">ç™¼ç”ŸéŒ¯èª¤</h2>
            </div>
            <div className="space-y-4 text-slate-300">
              <p>éŒ¯èª¤ä»£ç¢¼ï¼š<code className="bg-red-900/30 px-2 py-1 rounded text-red-300 text-sm">{error.code || 'Unknown'}</code></p>
              
              {isPermissionError && (
                <div className="bg-slate-800 p-4 rounded-lg text-sm border border-slate-700">
                  <p className="font-bold text-white mb-2">é€™æ˜¯ã€Œè³‡æ–™åº«æ¬Šé™ã€å•é¡Œï¼š</p>
                  <p>è«‹å‰å¾€ Firebase Console > Firestore Database > Rules (è¦å‰‡)ï¼Œå°‡å…§å®¹æ”¹æˆï¼š</p>
                  <pre className="bg-black p-2 mt-2 rounded text-green-400 overflow-x-auto">
allow read, write: if request.auth != null;
                  </pre>
                </div>
              )}
              
              {!isPermissionError && (
                 <p>è«‹å°‡æ­¤ç•«é¢æˆªåœ–çµ¦å·¥ç¨‹å¸«ã€‚</p>
              )}

              <button onClick={() => window.location.reload()} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg mt-4">é‡æ–°æ•´ç†</button>
            </div>
          </div>
        </div>
      );
    };

    const StudentView = ({ user, userData }) => {
      const [activeSection, setActiveSection] = React.useState('2-1');
      const sections = ['2-1', '2-2', '2-3', '2-4'];
      const totalQuestionsPerSection = 24;

      const toggleQuestion = async (section, questionIndex) => {
        if (!user) return;
        const currentSectionProgress = userData?.progress?.[section] || [];
        const isCompleted = currentSectionProgress.includes(questionIndex);
        let newProgress = [...currentSectionProgress];
        if (isCompleted) {
          newProgress = newProgress.filter(i => i !== questionIndex);
        } else {
          newProgress.push(questionIndex);
        }
        const userDocRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'students', user.uid);
        await updateDoc(userDocRef, {
          [`progress.${section}`]: newProgress,
          lastUpdated: serverTimestamp()
        });
      };

      const calculateProgress = (section) => {
        const completed = userData?.progress?.[section]?.length || 0;
        return Math.round((completed / totalQuestionsPerSection) * 100);
      };

      return (
        <div className="min-h-screen bg-slate-950 text-slate-100 flex flex-col">
          <header className="bg-slate-900 border-b border-slate-800 p-4 sticky top-0 z-10 shadow-md">
            <div className="flex justify-between items-center max-w-3xl mx-auto">
              <div className="flex items-center space-x-3">
                <div className="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center font-bold text-lg text-white">
                  {userData?.name?.[0] || 'ç”Ÿ'}
                </div>
                <div>
                  <h2 className="font-bold text-lg leading-tight">{userData?.name}</h2>
                  <p className="text-xs text-slate-400">åŠ æ²¹ï¼Œä¿æŒå°ˆæ³¨ï¼</p>
                </div>
              </div>
              <div className="text-right">
                 <div className="text-xs text-slate-400">ç¸½å®Œæˆé¡Œæ•¸</div>
                 <div className="text-xl font-mono font-bold text-green-400">
                   {Object.values(userData?.progress || {}).flat().length} / {sections.length * 24}
                 </div>
              </div>
            </div>
          </header>

          <div className="flex overflow-x-auto bg-slate-900/50 border-b border-slate-800 p-2 space-x-2 sticky top-[73px] z-10">
            {sections.map(sec => (
              <button
                key={sec}
                onClick={() => setActiveSection(sec)}
                className={`flex-1 py-2 px-4 rounded-lg font-medium text-sm whitespace-nowrap transition-all ${
                  activeSection === sec 
                    ? 'bg-blue-600 text-white shadow-lg shadow-blue-600/20' 
                    : 'bg-slate-800 text-slate-400 hover:bg-slate-700'
                }`}
              >
                {sec} <span className="ml-1 opacity-60 text-xs">({calculateProgress(sec)}%)</span>
              </button>
            ))}
          </div>

          <div className="flex-1 p-4 overflow-y-auto max-w-3xl mx-auto w-full">
            <div className="mb-6">
               <h3 className="text-slate-400 text-sm uppercase tracking-wider font-semibold mb-4 flex items-center">
                 <span className="mr-2">âœ…</span>
                 é»æ“Šå®Œæˆçš„é¡Œç›® ({activeSection})
               </h3>
               
               <div className="grid grid-cols-4 sm:grid-cols-6 gap-3">
                 {Array.from({ length: totalQuestionsPerSection }).map((_, idx) => {
                   const qNum = idx + 1;
                   const isDone = userData?.progress?.[activeSection]?.includes(qNum);
                   
                   return (
                     <button
                       key={qNum}
                       onClick={() => toggleQuestion(activeSection, qNum)}
                       className={`aspect-square rounded-xl flex items-center justify-center text-lg font-bold transition-all duration-200 transform active:scale-90 ${
                         isDone 
                           ? 'bg-green-500 text-white shadow-lg shadow-green-500/40 border-b-4 border-green-700 translate-y-[2px]' 
                           : 'bg-slate-800 text-slate-500 border-b-4 border-slate-700 hover:bg-slate-750'
                       }`}
                     >
                       {qNum}
                     </button>
                   );
                 })}
               </div>
            </div>
          </div>
        </div>
      );
    };

    const TeacherDashboard = ({ students }) => {
      const sections = ['2-1', '2-2', '2-3', '2-4'];
      const totalPerSection = 24;
      const totalQuestions = sections.length * totalPerSection;

      const sortedStudents = React.useMemo(() => {
        return [...students].sort((a, b) => {
          const countA = Object.values(a.progress || {}).flat().length;
          const countB = Object.values(b.progress || {}).flat().length;
          return countB - countA;
        });
      }, [students]);

      const getStudentTotal = (student) => {
        return Object.values(student.progress || {}).flat().length;
      };

      const getSectionProgress = (student, section) => {
        return (student.progress?.[section] || []).length;
      };

      return (
        <div className="min-h-screen bg-slate-900 text-white p-6 overflow-hidden flex flex-col">
          <header className="mb-6 flex justify-between items-center bg-slate-800 p-4 rounded-2xl shadow-xl border border-slate-700">
            <div className="flex items-center gap-3">
              <div className="p-3 bg-yellow-500 rounded-xl text-2xl">ğŸ†</div>
              <div>
                <h1 className="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-yellow-400 to-orange-500">
                  å³æ™‚é€²åº¦æ’è¡Œæ¦œ
                </h1>
                <p className="text-slate-400">ç¸½é¡Œæ•¸: {totalQuestions} é¡Œ (æ¯å–®å…ƒ 24 é¡Œ)</p>
              </div>
            </div>
            <div className="text-right">
               <div className="text-3xl font-mono font-bold text-blue-400">{students.length}</div>
               <div className="text-xs text-slate-500 uppercase tracking-wider">åœ¨ç·šäººæ•¸</div>
            </div>
          </header>

          <div className="flex-1 overflow-y-auto pr-2 space-y-3">
            {sortedStudents.map((student, index) => {
              const totalDone = getStudentTotal(student);
              const percentage = Math.min(100, (totalDone / totalQuestions) * 100);
              
              let rankColor = "text-slate-400";
              let bgColor = "bg-slate-800";
              let medal = null;
              
              if (index === 0 && totalDone > 0) {
                rankColor = "text-yellow-400";
                bgColor = "bg-slate-800 border border-yellow-500/30 shadow-[0_0_15px_rgba(234,179,8,0.2)]";
                medal = <span className="text-yellow-400">ğŸ¥‡</span>;
              } else if (index === 1 && totalDone > 0) {
                rankColor = "text-slate-300";
                medal = <span className="text-slate-300">ğŸ¥ˆ</span>;
              } else if (index === 2 && totalDone > 0) {
                rankColor = "text-orange-400";
                medal = <span className="text-orange-400">ğŸ¥‰</span>;
              }

              return (
                <div key={student.id} className={`relative rounded-xl p-4 transition-all duration-500 ${bgColor}`}>
                  <div className="flex items-center gap-4 mb-2 relative z-10">
                    <div className={`font-mono font-bold text-xl w-8 text-center ${rankColor}`}>
                      #{index + 1}
                    </div>
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center gap-2">
                        <h3 className="text-xl font-bold truncate">{student.name}</h3>
                        {medal}
                      </div>
                    </div>
                    <div className="text-right">
                      <span className="text-2xl font-bold font-mono text-blue-400">{totalDone}</span>
                      <span className="text-slate-500 text-sm"> / {totalQuestions}</span>
                    </div>
                  </div>

                  <div className="h-4 bg-slate-700/50 rounded-full overflow-hidden mb-3 relative">
                     <div 
                       className="h-full bg-gradient-to-r from-blue-600 via-purple-500 to-pink-500 transition-all duration-700 ease-out relative"
                       style={{ width: `${percentage}%` }}
                     >
                       <div className="absolute top-0 left-0 right-0 bottom-0 bg-gradient-to-r from-transparent via-white/20 to-transparent animate-shimmer" style={{backgroundSize: '200% 100%'}}></div>
                     </div>
                  </div>

                  <div className="grid grid-cols-4 gap-2 text-xs text-slate-400">
                    {sections.map(sec => {
                      const secProgress = getSectionProgress(student, sec);
                      const isDone = secProgress === totalPerSection;
                      return (
                        <div key={sec} className="flex items-center gap-2 bg-slate-900/50 rounded px-2 py-1">
                          <span className={`${isDone ? 'text-green-400 font-bold' : ''}`}>{sec}</span>
                          <div className="flex-1 h-1.5 bg-slate-700 rounded-full overflow-hidden">
                            <div 
                              className={`h-full rounded-full transition-all duration-500 ${isDone ? 'bg-green-500' : 'bg-blue-500'}`}
                              style={{ width: `${(secProgress / totalPerSection) * 100}%` }}
                            />
                          </div>
                          <span className="font-mono w-5 text-right">{secProgress}</span>
                        </div>
                      )
                    })}
                  </div>
                </div>
              );
            })}
            
            {sortedStudents.length === 0 && (
               <div className="text-center py-20 text-slate-500">
                 <p className="text-xl">ç­‰å¾…å­¸ç”ŸåŠ å…¥...</p>
                 <p className="text-sm mt-2">è«‹å­¸ç”Ÿè¼¸å…¥åå­—åŠ å…¥èª²å ‚</p>
               </div>
            )}
          </div>
        </div>
      );
    };

    // --- ä¸»ç¨‹å¼ ---
    const App = () => {
      const [user, setUser] = React.useState(null);
      const [userData, setUserData] = React.useState(null);
      const [students, setStudents] = React.useState([]);
      const [isTeacher, setIsTeacher] = React.useState(false);
      const [profileLoading, setProfileLoading] = React.useState(true); 
      const [authError, setAuthError] = React.useState(null);

      // 1. ç™»å…¥è™•ç†
      React.useEffect(() => {
        const initAuth = async () => {
          try {
            await signInAnonymously(auth);
          } catch (err) {
            console.error("Auth Error:", err);
            setAuthError(err);
          }
        };
        initAuth();

        const unsubscribe = onAuthStateChanged(auth, (u) => {
          setUser(u);
          // å¦‚æœæ²’æœ‰ä½¿ç”¨è€…ï¼Œä¹Ÿè¦çµæŸ loading è®“ç•«é¢é¡¯ç¤ºç™»å…¥é 
          if (!u) setProfileLoading(false); 
        });
        return () => unsubscribe();
      }, []);

      // 2. è®€å–å€‹äººè³‡æ–™ (å«éŒ¯èª¤è™•ç†)
      React.useEffect(() => {
        if (!user || isTeacher) {
            if (isTeacher) setProfileLoading(false);
            return;
        }

        setProfileLoading(true);
        const userDocRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'students', user.uid);
        
        // å®‰å…¨æ©Ÿåˆ¶ï¼šå¦‚æœ 10 ç§’é‚„æ²’è®€åˆ°è³‡æ–™ï¼Œé¡¯ç¤ºè¶…æ™‚éŒ¯èª¤
        const timer = setTimeout(() => {
             if (profileLoading) {
                 setAuthError({ code: 'timeout', message: 'é€£ç·šé€¾æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–é‡æ–°æ•´ç†' });
                 setProfileLoading(false);
             }
        }, 10000);

        const unsub = onSnapshot(userDocRef, (docSnap) => {
          clearTimeout(timer); // æˆåŠŸè®€åˆ°è³‡æ–™ï¼Œæ¸…é™¤è¨ˆæ™‚å™¨
          if (docSnap.exists()) {
            setUserData(docSnap.data());
          } else {
            setUserData(null); 
          }
          setProfileLoading(false); 
        }, (err) => {
           clearTimeout(timer); // ç™¼ç”ŸéŒ¯èª¤ï¼Œæ¸…é™¤è¨ˆæ™‚å™¨
           console.error("Snapshot Error:", err);
           // é¡¯ç¤ºéŒ¯èª¤çµ¦ä½¿ç”¨è€…çœ‹ (é€™å°±æ˜¯æ‚¨ä¹‹å‰ç¼ºå°‘çš„ï¼)
           setAuthError(err); 
           setProfileLoading(false); 
        });
        return () => {
            unsub();
            clearTimeout(timer);
        };
      }, [user, isTeacher]);

      // 3. è€å¸«æ¨¡å¼è®€å–æ‰€æœ‰å­¸ç”Ÿ
      React.useEffect(() => {
        if (!user) return;

        const studentsRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'students');
        const q = query(studentsRef); 
        
        const unsub = onSnapshot(q, (snapshot) => {
          const studentsList = [];
          snapshot.forEach((doc) => {
            studentsList.push({ id: doc.id, ...doc.data() });
          });
          setStudents(studentsList);
        }, (err) => console.error("Data fetch error:", err));

        return () => unsub();
      }, [user]);

      const handleJoin = async (name) => {
        if (!user) return;
        const userDocRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'students', user.uid);
        
        const docSnap = await getDoc(userDocRef);
        
        if (!docSnap.exists()) {
          await setDoc(userDocRef, {
            name,
            joinedAt: serverTimestamp(),
            progress: { '2-1': [], '2-2': [], '2-3': [], '2-4': [] }
          });
        } else {
            await updateDoc(userDocRef, { name });
        }
      };

      if (authError) {
        return <ErrorScreen error={authError} />;
      }

      if (isTeacher) {
        return <TeacherDashboard students={students} />;
      }
      
      if (profileLoading && !isTeacher) {
        return <LoadingScreen />;
      }

      if (!user || !userData) {
        return <LoginScreen onJoin={handleJoin} isTeacher={isTeacher} setIsTeacher={setIsTeacher} authReady={!!user} />;
      }

      return <StudentView user={user} userData={userData} />;
    };

    // æ¸²æŸ“æ‡‰ç”¨ç¨‹å¼
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
