<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>班級作業進度賽跑榜</title>
  
  <!-- 1. 載入 Tailwind CSS (樣式) -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- 2. 載入 React 和 Babel (核心) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- 3. 設定 Import Map (讓瀏覽器知道哪裡找 Firebase 和 Icon) -->
  <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
  </script>

  <style>
    /* 自定義動畫 */
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    .animate-shimmer {
      animation: shimmer 2s infinite;
    }
  </style>
</head>
<body class="bg-slate-950 text-slate-100">
  <div id="root"></div>

  <!-- 4. 主要程式碼 (React 邏輯) -->
  <script type="text/babel" data-type="module">
    import { initializeApp } from 'firebase/app';
    import { 
      getFirestore, collection, doc, setDoc, onSnapshot, 
      serverTimestamp, query, orderBy, increment, updateDoc, getDoc 
    } from 'firebase/firestore';
    import { 
      getAuth, signInAnonymously, onAuthStateChanged 
    } from 'firebase/auth';
    import { Trophy, User, BarChart3, CheckCircle2, Medal, Activity, Loader2, AlertCircle, ExternalLink, Globe } from 'lucide-react';

    // --- 設定區 ---
    const firebaseConfig = {
      apiKey: "AIzaSyAjmg0KXLaR_Z6Bj_nwyLN2Z2QPBOPMLvw",
      authDomain: "math-smart1.firebaseapp.com",
      projectId: "math-smart1",
      storageBucket: "math-smart1.firebasestorage.app",
      messagingSenderId: "867006036032",
      appId: "1:867006036032:web:bb23af4520c316b5ad07a5"
    };

    const APP_ID = "math-class-2024";

    // 初始化 Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- 元件 ---

    const LoginScreen = ({ onJoin, isTeacher, setIsTeacher, authReady }) => {
      const [name, setName] = React.useState('');
      const [loading, setLoading] = React.useState(false);

      const handleJoin = async () => {
        if (!name.trim()) return;
        setLoading(true);
        await onJoin(name);
        setLoading(false);
      };

      return (
        <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4 font-sans text-slate-100">
          <div className="max-w-md w-full bg-slate-800 rounded-2xl shadow-2xl overflow-hidden border border-slate-700">
            <div className="bg-blue-600 p-6 text-center">
              <Activity className="w-12 h-12 text-white mx-auto mb-2" />
              <h1 className="text-2xl font-bold text-white">數學作業衝刺賽</h1>
              <p className="text-blue-200 text-sm">2-1 至 2-4 進度追蹤</p>
            </div>
            <div className="p-8 space-y-6">
              <div>
                <label className="block text-sm font-medium text-slate-300 mb-2">
                  輸入你的名字開始
                </label>
                <input
                  type="text"
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  placeholder="例如：王小明"
                  className="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-white placeholder-slate-400 transition-all"
                  onKeyDown={(e) => e.key === 'Enter' && handleJoin()}
                  disabled={!authReady}
                />
              </div>
              
              <button
                onClick={handleJoin}
                disabled={loading || !name.trim() || !authReady}
                className="w-full bg-blue-500 hover:bg-blue-600 active:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl transition-all transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-blue-500/30"
              >
                {!authReady ? '連線中...' : loading ? '加入中...' : '開始做題！'}
              </button>

              <div className="pt-4 border-t border-slate-700">
                 <button
                  onClick={() => setIsTeacher(true)}
                  disabled={!authReady}
                  className="w-full text-sm text-slate-500 hover:text-slate-300 transition-colors disabled:opacity-50"
                >
                  我是老師 (開啟白板模式)
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    const LoadingScreen = () => (
      <div className="min-h-screen bg-slate-950 flex flex-col items-center justify-center text-slate-400">
        <Loader2 className="w-10 h-10 animate-spin mb-4 text-blue-500" />
        <p>正在恢復你的進度...</p>
      </div>
    );

    // 錯誤顯示畫面 (智慧判斷錯誤類型)
    const ErrorScreen = ({ error }) => {
      const isDomainError = error.code === 'auth/unauthorized-domain';
      const isConfigError = error.code === 'auth/configuration-not-found';
      
      return (
        <div className="min-h-screen bg-slate-950 flex items-center justify-center p-4">
          <div className="max-w-lg w-full bg-slate-900 border border-red-800 rounded-xl p-6 shadow-2xl">
            <div className="flex items-center gap-3 mb-4 text-red-500">
              <AlertCircle className="w-8 h-8" />
              <h2 className="text-xl font-bold">連線設定問題</h2>
            </div>
            <div className="space-y-4 text-slate-300">
              <p>
                Firebase 回傳錯誤：<code className="bg-red-900/30 px-2 py-1 rounded text-red-300 text-sm">{error.code}</code>
              </p>

              {isDomainError && (
                <div className="bg-slate-800 p-4 rounded-lg text-sm border border-slate-700">
                  <p className="font-bold text-white mb-2 flex items-center gap-2">
                    <Globe className="w-4 h-4" />
                    這是網域授權問題：
                  </p>
                  <p className="mb-2">因為您已將網站發布上線，必須告訴 Firebase 這個新網址是安全的。</p>
                  <ol className="list-decimal list-inside space-y-2 text-slate-400 ml-1">
                    <li>複製您現在瀏覽器網址列上的網域 (例如: <code>myapp.vercel.app</code>)。</li>
                    <li>前往 <a href="https://console.firebase.google.com/project/math-smart1/authentication/settings" target="_blank" className="text-blue-400 underline">Firebase Authentication 設定</a>。</li>
                    <li>點擊 <strong>Authorized domains (已授權網域)</strong>。</li>
                    <li>點擊 <strong>Add domain</strong> 並貼上網址。</li>
                  </ol>
                </div>
              )}

              {isConfigError && (
                <div className="bg-slate-800 p-4 rounded-lg text-sm border border-slate-700">
                  <p className="font-bold text-white mb-2">需要開啟匿名登入：</p>
                  <p>請前往 Firebase Console > Authentication > Sign-in method 開啟 Anonymous。</p>
                </div>
              )}
              
              {!isDomainError && !isConfigError && (
                 <div className="bg-slate-800 p-4 rounded-lg text-sm border border-slate-700">
                    <p>未知的錯誤，請檢查 Firebase 設定或重新整理。</p>
                 </div>
              )}

              <button 
                onClick={() => window.location.reload()}
                className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2"
              >
                我已經設定好了，重新整理
              </button>
            </div>
          </div>
        </div>
      );
    };

    const StudentView = ({ user, userData }) => {
      const [activeSection, setActiveSection] = React.useState('2-1');
      
      const sections = ['2-1', '2-2', '2-3', '2-4'];
      const totalQuestionsPerSection = 24;

      const toggleQuestion = async (section, questionIndex) => {
        if (!user) return;
        
        const currentSectionProgress = userData?.progress?.[section] || [];
        const isCompleted = currentSectionProgress.includes(questionIndex);
        
        let newProgress = [...currentSectionProgress];
        if (isCompleted) {
          newProgress = newProgress.filter(i => i !== questionIndex);
        } else {
          newProgress.push(questionIndex);
        }

        const userDocRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'students', user.uid);
        
        await updateDoc(userDocRef, {
          [`progress.${section}`]: newProgress,
          lastUpdated: serverTimestamp()
        });
      };

      const calculateProgress = (section) => {
        const completed = userData?.progress?.[section]?.length || 0;
        return Math.round((completed / totalQuestionsPerSection) * 100);
      };

      return (
        <div className="min-h-screen bg-slate-950 text-slate-100 flex flex-col">
          <header className="bg-slate-900 border-b border-slate-800 p-4 sticky top-0 z-10 shadow-md">
            <div className="flex justify-between items-center max-w-3xl mx-auto">
              <div className="flex items-center space-x-3">
                <div className="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center font-bold text-lg">
                  {userData?.name?.[0] || '生'}
                </div>
                <div>
                  <h2 className="font-bold text-lg leading-tight">{userData?.name}</h2>
                  <p className="text-xs text-slate-400">加油，保持專注！</p>
                </div>
              </div>
              <div className="text-right">
                 <div className="text-xs text-slate-400">總完成題數</div>
                 <div className="text-xl font-mono font-bold text-green-400">
                   {Object.values(userData?.progress || {}).flat().length} / {sections.length * 24}
                 </div>
              </div>
            </div>
          </header>

          <div className="flex overflow-x-auto bg-slate-900/50 border-b border-slate-800 p-2 space-x-2 sticky top-[73px] z-10">
            {sections.map(sec => (
              <button
                key={sec}
                onClick={() => setActiveSection(sec)}
                className={`flex-1 py-2 px-4 rounded-lg font-medium text-sm whitespace-nowrap transition-all ${
                  activeSection === sec 
                    ? 'bg-blue-600 text-white shadow-lg shadow-blue-600/20' 
                    : 'bg-slate-800 text-slate-400 hover:bg-slate-700'
                }`}
              >
                {sec} <span className="ml-1 opacity-60 text-xs">({calculateProgress(sec)}%)</span>
              </button>
            ))}
          </div>

          <div className="flex-1 p-4 overflow-y-auto max-w-3xl mx-auto w-full">
            <div className="mb-6">
               <h3 className="text-slate-400 text-sm uppercase tracking-wider font-semibold mb-4 flex items-center">
                 <CheckCircle2 className="w-4 h-4 mr-2" />
                 點擊完成的題目 ({activeSection})
               </h3>
               
               <div className="grid grid-cols-4 sm:grid-cols-6 gap-3">
                 {Array.from({ length: totalQuestionsPerSection }).map((_, idx) => {
                   const qNum = idx + 1;
                   const isDone = userData?.progress?.[activeSection]?.includes(qNum);
                   
                   return (
                     <button
                       key={qNum}
                       onClick={() => toggleQuestion(activeSection, qNum)}
                       className={`aspect-square rounded-xl flex items-center justify-center text-lg font-bold transition-all duration-200 transform active:scale-90 ${
                         isDone 
                           ? 'bg-green-500 text-white shadow-lg shadow-green-500/40 border-b-4 border-green-700 translate-y-[2px]' 
                           : 'bg-slate-800 text-slate-500 border-b-4 border-slate-700 hover:bg-slate-750'
                       }`}
                     >
                       {qNum}
                     </button>
                   );
                 })}
               </div>
            </div>
          </div>
        </div>
      );
    };

    const TeacherDashboard = ({ students }) => {
      const sections = ['2-1', '2-2', '2-3', '2-4'];
      const totalPerSection = 24;
      const totalQuestions = sections.length * totalPerSection;

      const sortedStudents = React.useMemo(() => {
        return [...students].sort((a, b) => {
          const countA = Object.values(a.progress || {}).flat().length;
          const countB = Object.values(b.progress || {}).flat().length;
          return countB - countA;
        });
      }, [students]);

      const getStudentTotal = (student) => {
        return Object.values(student.progress || {}).flat().length;
      };

      const getSectionProgress = (student, section) => {
        return (student.progress?.[section] || []).length;
      };

      return (
        <div className="min-h-screen bg-slate-900 text-white p-6 overflow-hidden flex flex-col">
          <header className="mb-6 flex justify-between items-center bg-slate-800 p-4 rounded-2xl shadow-xl border border-slate-700">
            <div className="flex items-center gap-3">
              <div className="p-3 bg-yellow-500 rounded-xl">
                 <Trophy className="w-8 h-8 text-white" />
              </div>
              <div>
                <h1 className="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-yellow-400 to-orange-500">
                  即時進度排行榜
                </h1>
                <p className="text-slate-400">總題數: {totalQuestions} 題 (每單元 24 題)</p>
              </div>
            </div>
            <div className="text-right">
               <div className="text-3xl font-mono font-bold text-blue-400">{students.length}</div>
               <div className="text-xs text-slate-500 uppercase tracking-wider">在線人數</div>
            </div>
          </header>

          <div className="flex-1 overflow-y-auto pr-2 space-y-3">
            {sortedStudents.map((student, index) => {
              const totalDone = getStudentTotal(student);
              const percentage = Math.min(100, (totalDone / totalQuestions) * 100);
              
              let rankColor = "text-slate-400";
              let bgColor = "bg-slate-800";
              let medal = null;
              
              if (index === 0 && totalDone > 0) {
                rankColor = "text-yellow-400";
                bgColor = "bg-slate-800 border border-yellow-500/30 shadow-[0_0_15px_rgba(234,179,8,0.2)]";
                medal = <Medal className="w-6 h-6 text-yellow-400 fill-yellow-400/20" />;
              } else if (index === 1 && totalDone > 0) {
                rankColor = "text-slate-300";
                medal = <Medal className="w-6 h-6 text-slate-300" />;
              } else if (index === 2 && totalDone > 0) {
                rankColor = "text-orange-400";
                medal = <Medal className="w-6 h-6 text-orange-400" />;
              }

              return (
                <div key={student.id} className={`relative rounded-xl p-4 transition-all duration-500 ${bgColor}`}>
                  <div className="flex items-center gap-4 mb-2 relative z-10">
                    <div className={`font-mono font-bold text-xl w-8 text-center ${rankColor}`}>
                      #{index + 1}
                    </div>
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center gap-2">
                        <h3 className="text-xl font-bold truncate">{student.name}</h3>
                        {medal}
                      </div>
                    </div>
                    <div className="text-right">
                      <span className="text-2xl font-bold font-mono text-blue-400">{totalDone}</span>
                      <span className="text-slate-500 text-sm"> / {totalQuestions}</span>
                    </div>
                  </div>

                  <div className="h-4 bg-slate-700/50 rounded-full overflow-hidden mb-3 relative">
                     <div 
                       className="h-full bg-gradient-to-r from-blue-600 via-purple-500 to-pink-500 transition-all duration-700 ease-out relative"
                       style={{ width: `${percentage}%` }}
                     >
                       <div className="absolute top-0 left-0 right-0 bottom-0 bg-gradient-to-r from-transparent via-white/20 to-transparent animate-shimmer" style={{backgroundSize: '200% 100%'}}></div>
                     </div>
                  </div>

                  <div className="grid grid-cols-4 gap-2 text-xs text-slate-400">
                    {sections.map(sec => {
                      const secProgress = getSectionProgress(student, sec);
                      const isDone = secProgress === totalPerSection;
                      return (
                        <div key={sec} className="flex items-center gap-2 bg-slate-900/50 rounded px-2 py-1">
                          <span className={`${isDone ? 'text-green-400 font-bold' : ''}`}>{sec}</span>
                          <div className="flex-1 h-1.5 bg-slate-700 rounded-full overflow-hidden">
                            <div 
                              className={`h-full rounded-full transition-all duration-500 ${isDone ? 'bg-green-500' : 'bg-blue-500'}`}
                              style={{ width: `${(secProgress / totalPerSection) * 100}%` }}
                            />
                          </div>
                          <span className="font-mono w-5 text-right">{secProgress}</span>
                        </div>
                      )
                    })}
                  </div>
                </div>
              );
            })}
            
            {sortedStudents.length === 0 && (
               <div className="text-center py-20 text-slate-500">
                 <p className="text-xl">等待學生加入...</p>
                 <p className="text-sm mt-2">請學生輸入名字加入課堂</p>
               </div>
            )}
          </div>
        </div>
      );
    };

    // --- 主程式 ---
    const App = () => {
      const [user, setUser] = React.useState(null);
      const [userData, setUserData] = React.useState(null);
      const [students, setStudents] = React.useState([]);
      const [isTeacher, setIsTeacher] = React.useState(false);
      const [profileLoading, setProfileLoading] = React.useState(true); 
      const [authError, setAuthError] = React.useState(null); // 新增錯誤狀態

      React.useEffect(() => {
        const initAuth = async () => {
          try {
            await signInAnonymously(auth);
          } catch (err) {
            // 不再顯示紅色錯誤訊息，直接設定錯誤狀態讓 UI 顯示引導
            setAuthError(err); 
          }
        };
        initAuth();

        const unsubscribe = onAuthStateChanged(auth, (u) => {
          setUser(u);
          if (!u) setProfileLoading(false); 
        });
        return () => unsubscribe();
      }, []);

      React.useEffect(() => {
        if (!user || isTeacher) {
            if (isTeacher) setProfileLoading(false);
            return;
        }

        setProfileLoading(true);
        const userDocRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'students', user.uid);
        const unsub = onSnapshot(userDocRef, (docSnap) => {
          if (docSnap.exists()) {
            setUserData(docSnap.data());
          } else {
            setUserData(null); 
          }
          setProfileLoading(false); 
        }, (err) => {
           // 靜默錯誤處理，避免干擾 UI
        });
        return () => unsub();
      }, [user, isTeacher]);

      React.useEffect(() => {
        if (!user) return;

        const studentsRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'students');
        const q = query(studentsRef); 
        
        const unsub = onSnapshot(q, (snapshot) => {
          const studentsList = [];
          snapshot.forEach((doc) => {
            studentsList.push({ id: doc.id, ...doc.data() });
          });
          setStudents(studentsList);
        }, (err) => {
            // 靜默錯誤處理
        });

        return () => unsub();
      }, [user]);

      const handleJoin = async (name) => {
        if (!user) return;
        const userDocRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'students', user.uid);
        
        const docSnap = await getDoc(userDocRef);
        
        if (!docSnap.exists()) {
          await setDoc(userDocRef, {
            name,
            joinedAt: serverTimestamp(),
            progress: { '2-1': [], '2-2': [], '2-3': [], '2-4': [] }
          });
        } else {
            await updateDoc(userDocRef, { name });
        }
      };

      // 如果發生 Auth 錯誤，優先顯示錯誤畫面
      if (authError) {
        return <ErrorScreen error={authError} />;
      }

      if (isTeacher) {
        return <TeacherDashboard students={students} />;
      }
      
      if (profileLoading && !isTeacher) {
        return <LoadingScreen />;
      }

      if (!user || !userData) {
        return <LoginScreen onJoin={handleJoin} isTeacher={isTeacher} setIsTeacher={setIsTeacher} authReady={!!user} />;
      }

      return <StudentView user={user} userData={userData} />;
    };

    // 渲染應用程式
    // 修正：將 ReactDOM.createRoot 替換為 ReactDOM.render，以兼容 UMD CDN 載入方式。
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
